function loadLevel(a){newStage(),generatedLevel=generateLevel(playerSettings.seed,a),squareSize=(1e3-(generatedLevel.size*squareGap+canvasBorder))/generatedLevel.size,setupTopPanel(),setupSquares(),setupPlayer(),startLevel()}function randomSeed(){changeSeed(Math.random().toString(36).replace(/[^a-z]+/g,""))}function changeSeed(a){playerSettings.seed=a,generatedLevel&&loadLevel(generatedLevel.level)}function setupTopPanel(){document.querySelector("#level").innerHTML=generatedLevel.level,document.querySelector("#target").innerHTML=generatedLevel.target}function setupSquares(){stage.squareContainers=[];for(var a=0;a<generatedLevel.size;a++){stage.squareContainers[a]=[];for(var b=0;b<generatedLevel.size;b++){var c=new PIXI.Container;c.x=(squareSize+squareGap)*a+canvasBorder,c.y=(squareSize+squareGap)*b+canvasBorder;var d=generatedLevel.map[a][b],e=null;d?(op=d.operator,e=new PIXI.Text(d.number,{font:"bold 48px Josefin Sans",fill:colors[op],align:"center"}),e.x=20,e.y=20):op="none";var f=new PIXI.Graphics,g=squareSize/2;f.lineStyle(6,colors[op],1),f.drawCircle(0+g,0+g,g),c.addChild(f),c.graphics=f,d&&(c.addChild(e),c.number=e),stage.addChild(c),stage.squareContainers[a][b]=c}}}function setupPlayer(){playerSettings.value=generatedLevel.previousTarget;var a=new PIXI.Container;a.moved=function(){this.x=(squareSize+squareGap)*playerSettings.x+canvasBorder,this.y=(squareSize+squareGap)*playerSettings.y+canvasBorder},a.moved();var b=new PIXI.Graphics,c=new PIXI.Text(playerSettings.value,{font:"bold 48px Josefin Sans",fill:16777215,align:"center"});c.x=20,c.y=20,b.beginFill(colors.player),b.lineStyle(5,colors.player,1);var d=squareSize/2;b.drawCircle(0+d,0+d,d),b.endFill(),a.addChild(b),a.playerBox=b,a.addChild(c),a.number=c,stage.addChild(a),stage.playerContainer=a}function keyPressed(a,b){pressed=a.keyCode,38==pressed&&(b||a.preventDefault(),0===playerSettings.y&&(playerSettings.y=generatedLevel.size),playerSettings.y-=1,submitMoves+="u"),40==pressed&&(b||a.preventDefault(),playerSettings.y===generatedLevel.size-1?playerSettings.y=0:playerSettings.y+=1,submitMoves+="d"),37==pressed&&(b||a.preventDefault(),0===playerSettings.x&&(playerSettings.x=generatedLevel.size),playerSettings.x-=1,submitMoves+="l"),39==pressed&&(b||a.preventDefault(),playerSettings.x===generatedLevel.size-1?playerSettings.x=0:playerSettings.x+=1,submitMoves+="r"),stage.playerContainer.moved(),playerValue(),checkGameOver()}function playerValue(){var a=generatedLevel.map[playerSettings.x][playerSettings.y];if(a){playerSettings.value=applyOperation(a,playerSettings.value),stage.playerContainer.number.text=playerSettings.value,generatedLevel.map[playerSettings.x][playerSettings.y]=null;var b=stage.squareContainers[playerSettings.x][playerSettings.y];b.graphics.clear();var c=squareSize/2;b.graphics.lineStyle(6,colors.none,1),b.graphics.drawCircle(0+c,0+c,c),b.removeChild(b.number),b.number=null,playerSettings.value==generatedLevel.target&&nextLevel()}}function checkGameOver(){for(var a=0;a<generatedLevel.size;a++)for(var b=0;b<generatedLevel.size;b++){var c=stage.squareContainers[a][b];if(c.number)return!1}var d=new PIXI.Text("GameOver",{font:"bold 80px Josefin Sans",fill:0,align:"center"});return d.anchor.set(.5,.5),d.x=GAME_WIDTH/2,d.y=GAME_HEIGHT/2,d.interactive=!0,d.mousedown=function(){randomSeed(),loadLevel(1)},stage.addChild(d),!0}function nextLevel(){endLevel(),loadLevel(generatedLevel.level+1)}function startLevel(){submitTimer=Date.now(),submitStart={x:playerSettings.x,y:playerSettings.y},submitMoves=""}function endLevel(){var a=Date.now()-submitTimer,b="http://miby.ienze.me";try{var c=new XMLHttpRequest;c.open("POST",b+"/api/level"),c.setRequestHeader("Content-Type","application/json;charset=UTF-8"),c.send(JSON.stringify({success:!0,name:playerSettings.name,seed:playerSettings.seed,generator:2,level:generatedLevel.level,value:playerSettings.value,time:a,start:submitStart,moves:submitMoves}))}catch(d){}}function generateLevel(a,b){var c=function(a){return Math.round(a.baseRange.from+a.rng()*(a.baseRange.to-a.baseRange.from))},d=function(b){var c=new xor4096(a+b);return{rng:c,level:b,baseRange:{from:0,to:0},size:0,previousTarget:0,target:0,targetOperations:0,targetUsefulOperations:0,targetPossibilities:0,allowedOperators:null,allowedOperations:null,usefulTiles:null,uselessTiles:null,map:null}},e=function(a){a.baseRange.from=a.level/-8,a.baseRange.to=a.level*a.level/16+a.level/6+4},f=function(a){a.size=7},g=function(a){var b=d(a.level-1);e(b),h(b),a.previousTarget=b.target},h=function(a){0===a.level?a.target=0:a.target=c(a)},j=function(a){var c=a.level+Math.E;a.targetOperations=Math.round(Math.max(1+b/8,Math.min(a.size*a.size,a.rng()*(2*Math.log(c*c))+(1+a.level/8))))},k=function(a){a.targetUsefulOperations=Math.round(a.targetOperations/2+a.rng()*a.targetOperations/2)},l=function(a){a.targetPossibilities=Math.round(Math.max(1,Math.min(a.targetUsefulOperations,4-a.level/6)))},m=function(a){var b=null,c=null;a.level<=2?(b=["plu"],c=["+"]):a.level<=21?(b=["plu","min"],c=["+","-"]):a.level<=42?(b=["plu","min"],c=["+","-","*"]):(b=["plu","min","tim","div"],c=["+","-","*","/"]),a.allowedOperators=b,a.allowedOperations=c},n=function(a){a.usefulTiles=[];var b=Math.round(a.targetUsefulOperations/a.targetPossibilities);for(i=0;i<a.targetPossibilities;i++){for(var c=0,d=a.previousTarget,e=null;a.usefulTiles.length+1<a.targetUsefulOperations&&b-1>=c;)e=genUsefulOperation(d,!1,a),a.usefulTiles.push(e),d=applyOperation(e,d),c++;e=genUsefulOperation(d,!0,a),a.usefulTiles.push(e)}},o=function(a){var b=function(a){return{number:c(a),operator:a.allowedOperators[Math.round(a.rng()*(a.allowedOperators.length-1))]}};for(a.uselessTiles=[];a.usefulTiles.length+a.uselessTiles.length<a.targetOperations;)a.uselessTiles.push(b(a))},p=function(a){levelDecorator=new LevelDecorator(a),a.map=levelDecorator.decorateMap()};return generatorState=d(b),e(generatorState),f(generatorState),g(generatorState),h(generatorState),j(generatorState),k(generatorState),l(generatorState),m(generatorState),n(generatorState),o(generatorState),p(generatorState),generatorState}var colors={plu:"0x008606",min:"0xff8000",tim:"0xf3f129",div:"0xf32929",none:"0xe1e1e1",player:"0x2eb5b3"},renderer=pixySetup(),squareGap=30,canvasBorder=5,squareSize=null,generatedLevel,playerSettings={seed:"miby",name:name,x:0,y:0,value:null};document.addEventListener("touchmove",function(a){a.preventDefault()},!1);var swipe=new Hammer(document.querySelector("#miby"),{preventDefault:!0});swipe.get("swipe").set({direction:Hammer.DIRECTION_ALL}),swipe.on("dragleft swipeleft",function(a){keyPressed({keyCode:37},!0)}),swipe.on("dragright swiperight",function(a){keyPressed({keyCode:39},!0)}),swipe.on("dragup swipeup",function(a){keyPressed({keyCode:38},!0)}),swipe.on("dragdown swipedown",function(a){keyPressed({keyCode:40},!0)}),document.addEventListener("keydown",keyPressed);var submitTimer=null,submitStart=null,submitMoves=null;randomSeed(),loadLevel(1);var render=function(){renderer.render(stage),requestAnimationFrame(render)};render();var GAME_WIDTH=1e3,GAME_HEIGHT=1e3,stage=null;pixySetup=function(){function a(){var a=window.innerWidth;450>=a&&(a*=.9),ratio=Math.min(a/GAME_WIDTH,(.75*window.innerHeight-16)/GAME_HEIGHT),stage&&(stage.scale.x=stage.scale.y=ratio),renderer.resize(Math.ceil(GAME_WIDTH*ratio),Math.ceil(GAME_HEIGHT*ratio))}var b={antialiasing:!0,transparent:!1,resolution:window.devicePixelRatio,autoResize:!0,backgroundColor:16777215};renderer=new PIXI.CanvasRenderer(GAME_WIDTH,GAME_HEIGHT,b);var c=document.querySelector("#miby");return c.appendChild(renderer.view),window.addEventListener("resize",a),a(),renderer},newStage=function(){return stage=new PIXI.Container,stage.scale.x=stage.scale.y=ratio,stage};var genUsefulOperation=function(a,b,c){if(b){var d=c.target-a;return{number:Math.abs(d),operator:d>=0?"plu":"min"}}var e=c.allowedOperations[Math.round(c.rng()*(c.allowedOperations.length-1))];switch(e){case"+":var f=c.rng()*c.baseRange.to;return f=Math.round((f+c.target)/2),{number:Math.abs(f-a),operator:"plu"};case"-":var g=c.rng()*(a-c.baseRange.from);return g=Math.round((g+c.target)/2),{number:Math.abs(g-a),operator:"min"};case"*":var h=c.rng()*c.baseRange.to;return h=(h+c.target)/2,0===h||0===a?genUsefulOperation(a,b,c):(h=Math.round(h/a),{number:h,operator:"tim"});case"/":var i=c.rng()*(a-c.baseRange.from);return i=(i+c.target)/2,0===i||0===a?genUsefulOperation(a,b,c):(i=Math.round(i*a),{number:i,operator:"div"});default:throw"Illegal miby operation "+e}},applyOperation=function(a,b){switch(a.operator){case"plu":return b+a.number;case"min":return b-a.number;case"tim":return b*a.number;case"div":return Math.round(b/a.number)}};